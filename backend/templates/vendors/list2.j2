{% extends "_layouts/base.j2" %}
{% block content %}
<section class="section">
    <div class="container">
        <h1 class="title is-2">vendors</h1>
        <div class="columns">
            <div class="column">
                <button hx-get="{{ url_for('new_tenant_form') }}" hx-target="#tenant-form" hx-swap="innerHTML"
                    class="button is-primary mb-4">
                    <span class="icon"><i class="fas fa-plus"></i></span>
                    <span>Add New Tenant</span>
                </button>
            </div>
            <div class="column is-narrow">
                <div class="field has-addons">
                    <div class="control">
                        <input class="input" type="text" placeholder="Search vendors" id="search-input">
                    </div>
                    <div class="control">
                        <button class="button is-info" id="search-button">
                            <span class="icon"><i class="fas fa-search"></i></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tenant-form" class="mb-4"></div>

        <div id="tenant-list">
            <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Domain</th>
                        <th>Active</th>
                        <th>Subscription</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tenant in vendors %}
                    <tr>
                        <td>{{ tenant.name }}</td>
                        <td>{{ tenant.domain }}</td>
                        <td>
                            <div class="field">
                                <input id="is-active-{{ tenant.id }}" type="checkbox" class="switch is-rounded"
                                    {{ 'checked' if tenant.is_active else '' }}
                                    hx-put="{{ url_for('toggle_tenant_active', id=tenant.id) }}" hx-swap="none">
                                <label for="is-active-{{ tenant.id }}"></label>
                            </div>
                        </td>
                        <td>{{ tenant.subscription_plan }}</td>
                        <td>
                            <div class="buttons are-small">
                                <button 
                                    class="button is-info" 
                                    title="View"
                                    hx-get="{{ url_for('read_tenant', id=tenant.id) }}" 
                                    hx-trigger="click" 
                                    hx-swap="innerHTML"
                                    hx-target="#tenant-details"
                                    >
                                    <span class="icon"><i class="fas fa-eye"></i></span>
                                </button>

                                <button 
                                    class="button is-info" 
                                    title="Edit"
                                    hx-get="{{ url_for('edit_tenant_form', id=tenant.id) }}" 
                                    hx-target="#tenant-form"
                                    hx-swap="outerHTML" onclick="document.querySelector('#tenant-details')
                                            .classList.remove('is-active')">
                                    <span class="icon"><i class="fas fa-edit"></i></span>
                                    <span>Edit</span>
                                </button>

                                <button class="button is-danger" title="Delete"
                                    hx-delete="{{ url_for('delete_tenant', id=tenant.id) }}"
                                    hx-confirm="Are you sure you want to delete this tenant?" hx-target="closest tr"
                                    hx-swap="outerHTML swap:1s">
                                    <span class="icon"><i class="fas fa-trash"></i></span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <nav class="pagination is-centered" role="navigation" aria-label="pagination">
            <a class="pagination-previous" {{ 'disabled' if pagination.page==1 else '' }}
                hx-get="vendors?page={{pagination.page-1}}" hx-target="#tenant-list"
                hx-swap="outerHTML transition:fade">Previous</a>
            <a class="pagination-next" {{ 'disabled' if pagination.page==pagination.pages else '' }}
                hx-get="vendors?page={{pagination.page+1}}&page_size={{pagination.page_size}}" hx-target="#tenant-list"
                hx-swap="outerHTML transition:fade">Next page</a>
            <ul class="pagination-list">
                {% for page in range(1, pagination.page + 1) %}
                <li>
                    <a class="pagination-link {{ 'is-current' if page == pagination.page else '' }}"
                        hx-get="vendors?page={{page}}" hx-target="#tenant-list">{{ page }}</a>
                </li>
                {% endfor %}
            </ul>
        </nav>
        <div id="tenant-details" class="modal">
            <div class="modal-background"></div>
            <div class="modal-content">
                <div class="box">
                    <!-- Tenant details will be loaded here -->
                </div>
            </div>
            <button class="modal-close is-large" aria-label="close"></button>
        </div>
        <div id="edit-modal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-content">
                <div class="box">
                    <!-- Your form content here -->
                </div>
            </div>
            <button class="modal-close is-large" aria-label="close"></button>
        </div>
    </div>
</section>

<script>
    document.addEventListener('htmx:afterSwap', function (event) {
        if (event.detail.target.id === 'tenant-details') {
            document.querySelector('#tenant-details').classList.add('is-active');
        }
    });

    document.querySelector('.modal-background').addEventListener('click', function () {
        document.querySelector('#tenant-details').classList.remove('is-active');
    });

    document.querySelector('.modal-close').addEventListener('click', function () {
        document.querySelector('#tenant-details').classList.remove('is-active');
    });

    document.querySelectorAll('.modal-background, .modal-close').forEach(function(el) {
    el.addEventListener('click', function() {
        var modal = this.closest('.modal');
        modal.querySelector('.modal-content').style.animation = 'fadeOut 0.3s';
        setTimeout(function() {
            modal.classList.remove('is-active');
        }, 300);
    });
});
</script> 
{% endblock %}